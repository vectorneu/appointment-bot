// ========== CONFIGURATION ==========
const SPREADSHEET_ID = '13CgX9qWEQE9VjfU_gd1f1gXpdHQ4dMPKEpurjLCNE4I';
const CALENDAR_ID = 'primary';
const SENDER_EMAIL = 'vectorneu05@gmail.com';
const KNOWLEDGE_FOLDER_ID = '1kHzUrPYarHxdzg0gKraJ738vfPF2PhBQ';
const GROQ_API_KEY = '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';

// ========== KNOWLEDGE BASE CONFIG ==========
const KNOWLEDGE_FILE_TYPES = [
  'application/vnd.google-apps.document',
  'application/vnd.google-apps.spreadsheet', 
  'text/plain',
  'application/pdf'
];

// ========== SYSTEM PROMPT ==========
const SYSTEM_PROMPT = `You are VectorAI - the official AI assistant for Vectorneu Solutions, an AI Chatbot & Automation Company based in Coimbatore, Tamil Nadu.

**COMPANY INFORMATION:**
- **Business:** AI Chatbot Development, Business Process Automation & AI Solutions
- **Location:** Coimbatore, Tamil Nadu  
- **Contact:** +91 9488005400 | vectorneu05@gmail.com
- **Core Services:**
  ü§ñ Custom Chatbot Development
  ‚ö° Business Automation & Workflow Optimization
  üéØ AI Consulting & Custom AI Solutions
  üìä Intelligent Data & Analytics

**RESPONSE GUIDELINES:**
- Keep responses SHORT and CONCISE (1-3 sentences maximum)
- Be professional, friendly, and helpful
- Always address the user's question directly first
- Use emojis sparingly only when they add value
- Redirect unrelated queries gently to company services

**KEY SCENARIOS:**
- **Appointment Requests:** Show booking form immediately
- **Service Inquiries:** Provide specific examples and benefits
- **Pricing Questions:** Explain custom pricing and suggest consultation
- **General Info:** Share relevant company details briefly

**IMPORTANT RULES:**
- ONLY use provided company information - never fabricate details
- Always maintain professional tone while being helpful
- Guide users toward next steps (consultation, booking, contact)
- Be proactive in offering assistance

**GOAL:** Provide accurate, concise responses that help users understand services and take action.`;

// ========== MAIN HTTP HANDLER ==========
function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  try {
    // Process your data
    const result = processRequest(e);
    
    // Return JSON response
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      data: result
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function handleRequest(e) {
  try {
    const params = (e && e.parameter) || {};
    const callback = params.callback || '';
    const action = params.action || '';
    
    console.log('üîÑ Action:', action, 'Parameters:', Object.keys(params));
    
    let response;
    
    switch(action) {
      case 'message':
        response = handleChatMessage(params.message);
        break;
      case 'bookAppointment':
        response = handleAppointmentBooking(params);
        break;
      case 'rescheduleAppointment':
        response = handleRescheduleAppointment(params);
        break;
      case 'test':
        response = { 
          success: true, 
          message: 'Hello! I\'m VectorAI ü§ñ\nYour assistant for AI chatbots & automation.\nHow can I help you today?' 
        };
        break;
      default:
        response = { 
          success: true, 
          message: 'Vectorneu AI Assistant is running!',
          available_actions: [
            'message - Chat with the AI',
            'bookAppointment - Schedule an appointment', 
            'rescheduleAppointment - Reschedule appointment',
            'test - Test server connection'
          ]
        };
    }
    
    if (callback) {
      return ContentService.createTextOutput(callback + '(' + JSON.stringify(response) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      return ContentService.createTextOutput(JSON.stringify(response))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('‚ùå Handler error:', error);
    
    const errorResponse = {
      success: false,
      error: 'Server error',
      message: error.toString()
    };
    
    const callback = (e && e.parameter && e.parameter.callback) || '';
    if (callback) {
      return ContentService.createTextOutput(callback + '(' + JSON.stringify(errorResponse) + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    } else {
      return ContentService.createTextOutput(JSON.stringify(errorResponse))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
}
// ========== SMART CHAT HANDLER ==========
function handleChatMessage(userMessage) {
  try {
    if (!userMessage || userMessage.trim().length < 2) {
      return {
        response: "Hi! I'm VectorAI ü§ñ How can I help with our AI services today?",
        showAppointmentForm: false
      };
    }
    
    const message = userMessage.toLowerCase().trim();
    
    // Check for quick responses first
    const quickResponse = getQuickResponse(message);
    if (quickResponse) {
      return quickResponse;
    }
    
    // Use Groq AI for intelligent responses
    const aiResponse = getAIResponseWithKnowledge(message);
    
    return {
      response: aiResponse.response,
      showAppointmentForm: aiResponse.showAppointmentForm || false
    };
    
  } catch (error) {
    console.error('‚ùå Chat error:', error);
    return {
      response: "I'd love to help with Vectorneu's AI services! What would you like to know?",
      showAppointmentForm: false
    };
  }
}

function getQuickResponse(message) {
  const quickMap = {
    'hi|hello|hey': "Hello! üëã I'm VectorAI. How can I assist with our AI services today?",
    'appointment|book|schedule|meeting': {
      response: "Great! Let's get you scheduled üóìÔ∏è I'll show the booking form now.",
      showAppointmentForm: true
    },
    'reschedule|change appointment': {
      response: "I can help you reschedule your appointment. Please use the Reschedule button below.",
      showAppointmentForm: false
    },
    'service|offer|do what': "We build AI chatbots & automation solutions! ü§ñ Custom AI, business automation, consulting.",
    'contact|email|phone|number': "üìû +91 9488005400\n‚úâÔ∏è vectorneu05@gmail.com\nüïò Mon-Fri 9AM-6PM",
    'price|cost|how much': "Pricing is customized per project. Book a free consultation for accurate quotes!",
    'where|location|based': "We're based in Coimbatore! üèôÔ∏è Serving clients worldwide.",
    'chatbot|ai assistant': "We build intelligent chatbots for customer service, sales, and support! 24/7 automated conversations.",
    'thanks|thank you': "You're welcome! üòä Let me know if you need anything else.",
    'bye|goodbye': "Goodbye! üëã Feel free to reach out if you need AI solutions!"
  };
  
  for (const [pattern, response] of Object.entries(quickMap)) {
    if (new RegExp(pattern).test(message)) {
      return typeof response === 'string' ? { response } : response;
    }
  }
  
  return null;
}

// ========== GROQ AI WITH KNOWLEDGE BASE ==========
function getAIResponseWithKnowledge(userMessage) {
  try {
    console.log('üß† Processing with AI and Knowledge Base...');
    
    const knowledgeContext = getRelevantKnowledge(userMessage);
    
    const prompt = `${SYSTEM_PROMPT}

**Current Knowledge Context:**
${knowledgeContext}

**User Message:** "${userMessage}"

**Instructions:**
- Respond concisely (1-3 sentences max)
- Use the knowledge context above for accurate information
- If appointment-related, set showAppointmentForm: true
- Be helpful and professional`;

    const aiResponse = callGroqAPI(prompt, userMessage);
    
    const showForm = shouldShowAppointmentForm(userMessage, aiResponse);
    
    return {
      response: aiResponse,
      showAppointmentForm: showForm
    };
    
  } catch (error) {
    console.error('‚ùå AI response error:', error);
    return {
      response: "I specialize in AI chatbots and automation solutions! How can I assist you today?",
      showAppointmentForm: false
    };
  }
}

function callGroqAPI(prompt, userMessage) {
  try {
    const payload = {
      messages: [
        {
          role: "system",
          content: prompt
        },
        {
          role: "user", 
          content: userMessage
        }
      ],
      model: "llama-3.1-8b-instant",
      temperature: 0.7,
      max_tokens: 200,
      stream: false
    };
    
    const options = {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${GROQ_API_KEY}`,
        "Content-Type": "application/json"
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    const response = UrlFetchApp.fetch("https://api.groq.com/openai/v1/chat/completions", options);
    const data = JSON.parse(response.getContentText());
    
    if (data.choices && data.choices[0]) {
      return data.choices[0].message.content.trim();
    } else {
      throw new Error('Invalid response from Groq API');
    }
    
  } catch (error) {
    console.error('‚ùå Groq API error:', error);
    throw error;
  }
}

function shouldShowAppointmentForm(message, response) {
  const appointmentKeywords = [
    'appointment', 'book', 'schedule', 'meeting', 'consult', 
    'demo', 'call', 'reserve', 'calendar'
  ];
  
  return appointmentKeywords.some(keyword => 
    message.toLowerCase().includes(keyword) || 
    response.toLowerCase().includes(keyword)
  );
}

// ========== KNOWLEDGE BASE FUNCTIONS ==========
function getRelevantKnowledge(query) {
  try {
    console.log('üîç Searching knowledge base for:', query);
    
    const folder = DriveApp.getFolderById(KNOWLEDGE_FOLDER_ID);
    if (!folder) {
      return "No knowledge base folder found.";
    }
    
    const files = folder.getFiles();
    let knowledgeContent = "";
    let fileCount = 0;
    
    while (files.hasNext() && fileCount < 5) {
      const file = files.next();
      
      if (KNOWLEDGE_FILE_TYPES.includes(file.getMimeType())) {
        try {
          const content = extractFileContent(file);
          if (content && content.length > 0) {
            knowledgeContent += `\n--- ${file.getName()} ---\n${content.substring(0, 1000)}...\n`;
            fileCount++;
          }
        } catch (fileError) {
          console.log('‚ö†Ô∏è Could not read file:', file.getName(), fileError);
        }
      }
    }
    
    if (knowledgeContent.length === 0) {
      return "No knowledge files found in the drive folder.";
    }
    
    console.log(`‚úÖ Found ${fileCount} knowledge files`);
    return knowledgeContent;
    
  } catch (error) {
    console.error('‚ùå Knowledge base error:', error);
    return "Knowledge base currently unavailable.";
  }
}

function extractFileContent(file) {
  try {
    const mimeType = file.getMimeType();
    
    switch(mimeType) {
      case 'application/vnd.google-apps.document':
        return DocumentApp.openById(file.getId()).getBody().getText();
        
      case 'application/vnd.google-apps.spreadsheet':
        const sheet = SpreadsheetApp.openById(file.getId()).getSheets()[0];
        const data = sheet.getDataRange().getValues();
        return data.slice(0, 10).map(row => row.join(', ')).join('\n');
        
      case 'text/plain':
        return file.getBlob().getDataAsString();
        
      case 'application/pdf':
        return "PDF content: " + file.getName();
        
      default:
        return `File: ${file.getName()} (${mimeType})`;
    }
  } catch (error) {
    console.error('Error extracting file content:', error);
    return null;
  }
}

function refreshKnowledgeBase() {
  try {
    console.log('üîÑ Refreshing knowledge base...');
    
    const folder = DriveApp.getFolderById(KNOWLEDGE_FOLDER_ID);
    const files = folder.getFiles();
    
    let summary = {
      totalFiles: 0,
      processedFiles: 0,
      fileTypes: {}
    };
    
    while (files.hasNext()) {
      const file = files.next();
      summary.totalFiles++;
      const mimeType = file.getMimeType();
      
      if (!summary.fileTypes[mimeType]) {
        summary.fileTypes[mimeType] = 0;
      }
      summary.fileTypes[mimeType]++;
      
      if (KNOWLEDGE_FILE_TYPES.includes(mimeType)) {
        summary.processedFiles++;
      }
    }
    
    return {
      success: true,
      message: `‚úÖ Knowledge base refreshed! ${summary.processedFiles}/${summary.totalFiles} files available.`,
      summary: summary
    };
    
  } catch (error) {
    console.error('‚ùå Knowledge base refresh error:', error);
    return { success: false, error: error.message };
  }
}

// ========== APPOINTMENT SYSTEM ==========
function handleAppointmentBooking(params) {
  try {
    console.log('üìÖ Starting appointment booking...');
    
    if (!params.fullName || params.fullName.trim().length < 2) {
      return { success: false, message: 'Please enter your full name' };
    }
    
    if (!params.email || !params.email.includes('@')) {
      return { success: false, message: 'Please enter a valid email address' };
    }
    
    if (!params.date || !params.time) {
      return { success: false, message: 'Please select date and time' };
    }
    
    const bookingData = {
      fullName: params.fullName.trim(),
      email: params.email.trim(),
      companyName: (params.companyName || '').trim(),
      purpose: params.purpose || 'AI Consultation',
      date: params.date,
      time: params.time,
      duration: parseInt(params.duration) || 60,
      additionalInfo: (params.additionalInfo || '').trim()
    };
    
    console.log('‚úÖ Data validated:', bookingData.fullName);
    
    // Try to create calendar event
    let calendarResult = { success: false };
    try {
      calendarResult = createCalendarEvent(bookingData);
      console.log('üìÖ Calendar result:', calendarResult);
    } catch (calendarError) {
      console.log('‚ö†Ô∏è Calendar creation failed, but continuing:', calendarError);
    }
    
    // Save to spreadsheet
    const sheetResult = saveToSpreadsheet(bookingData);
    if (!sheetResult.success) {
      return { success: false, message: 'Failed to save appointment: ' + sheetResult.error };
    }
    
    // Try to send email
    let emailResult = { success: false };
    try {
      emailResult = sendConfirmationEmail(bookingData);
      console.log('üìß Email result:', emailResult);
    } catch (emailError) {
      console.log('‚ö†Ô∏è Email sending failed:', emailError);
    }
    
    console.log('üéâ Appointment processed successfully!');
    
    return {
      success: true,
      message: '‚úÖ Appointment booked successfully!' + (emailResult.success ? ' Confirmation email sent.' : ''),
      appointmentId: sheetResult.appointmentId,
      emailSent: emailResult.success,
      calendarCreated: calendarResult.success
    };
    
  } catch (error) {
    console.error('‚ùå Booking error:', error);
    return { success: false, message: 'Booking failed: ' + error.message };
  }
}

function createCalendarEvent(bookingData) {
  try {
    console.log('üìÖ Creating calendar event...');
    
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    if (!calendar) {
      console.log('‚ùå Calendar not found');
      return { success: false, error: 'Calendar not found' };
    }
    
    // Parse date and time
    const [year, month, day] = bookingData.date.split('-').map(Number);
    const [hours, minutes] = bookingData.time.split(':').map(Number);
    
    const startTime = new Date(year, month - 1, day, hours, minutes);
    const endTime = new Date(startTime.getTime() + bookingData.duration * 60000);
    
    console.log('‚è∞ Event time:', { start: startTime, end: endTime });
    
    const eventTitle = `Vectorneu Appointment: ${bookingData.fullName}`;
    const eventDescription = `
Client: ${bookingData.fullName}
Email: ${bookingData.email}
Company: ${bookingData.companyName || 'N/A'}
Purpose: ${bookingData.purpose}
Duration: ${bookingData.duration} minutes

Additional Info: ${bookingData.additionalInfo || 'None'}

Booked via Vectorneu AI Assistant
Contact: ${SENDER_EMAIL} | +91 9488005400
    `.trim();
    
    const event = calendar.createEvent(
      eventTitle,
      startTime,
      endTime,
      {
        description: eventDescription,
        guests: bookingData.email,
        sendInvites: true
      }
    );
    
    console.log('‚úÖ Calendar event created:', event.getId());
    
    return {
      success: true,
      eventId: event.getId()
    };
    
  } catch (error) {
    console.error('‚ùå Calendar event creation failed:', error);
    return { success: false, error: error.message };
  }
}

function saveToSpreadsheet(bookingData) {
  try {
    console.log('üìä Saving to spreadsheet...');
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('Appointments');
    
    if (!sheet) {
      sheet = spreadsheet.insertSheet('Appointments');
      const headers = ['Timestamp', 'Name', 'Email', 'Company', 'Purpose', 'Date', 'Time', 'Duration', 'Status', 'Appointment ID'];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      console.log('‚úÖ Created new sheet with headers');
    }
    
    const appointmentId = 'VEC-' + Utilities.getUuid().substring(0, 8).toUpperCase();
    const timestamp = new Date();
    
    const rowData = [
      timestamp,
      bookingData.fullName,
      bookingData.email,
      bookingData.companyName || '',
      bookingData.purpose,
      bookingData.date,
      bookingData.time,
      bookingData.duration,
      'Confirmed',
      appointmentId
    ];
    
    sheet.appendRow(rowData);
    console.log('‚úÖ Saved to spreadsheet, row:', sheet.getLastRow());
    
    return {
      success: true,
      appointmentId: appointmentId
    };
    
  } catch (error) {
    console.error('‚ùå Spreadsheet error:', error);
    return { success: false, error: error.message };
  }
}

function sendConfirmationEmail(bookingData) {
  try {
    console.log('üìß Sending confirmation email...');
    
    const subject = '‚úÖ Appointment Confirmed - Vectorneu Solutions';
    
    const htmlBody = `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .header { background: #2563eb; color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; }
        .details { background: #f8fafc; padding: 15px; border-radius: 8px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚úÖ Appointment Confirmed</h1>
        <p>Vectorneu Solutions - AI & Chatbot Services</p>
    </div>
    
    <div class="content">
        <h2>Hello ${bookingData.fullName},</h2>
        <p>Your appointment has been successfully scheduled!</p>
        
        <div class="details">
            <h3>Appointment Details:</h3>
            <p><strong>Date:</strong> ${bookingData.date}</p>
            <p><strong>Time:</strong> ${bookingData.time}</p>
            <p><strong>Duration:</strong> ${bookingData.duration} minutes</p>
            <p><strong>Purpose:</strong> ${bookingData.purpose}</p>
            ${bookingData.companyName ? `<p><strong>Company:</strong> ${bookingData.companyName}</p>` : ''}
        </div>
        
        <p>We look forward to discussing your AI needs!</p>
        
        <p><strong>Contact us:</strong><br>
        üìß ${SENDER_EMAIL}<br>
        üìû +91 9488005400</p>
    </div>
</body>
</html>
    `.trim();
    
    const plainBody = `
APPOINTMENT CONFIRMED - Vectorneu Solutions

Hello ${bookingData.fullName},

Your appointment has been successfully scheduled.

DATE: ${bookingData.date}
TIME: ${bookingData.time}  
DURATION: ${bookingData.duration} minutes
PURPOSE: ${bookingData.purpose}
${bookingData.companyName ? `COMPANY: ${bookingData.companyName}` : ''}

We look forward to discussing your AI needs!

Contact: ${SENDER_EMAIL} | +91 9488005400
    `.trim();
    
    GmailApp.sendEmail(
      bookingData.email,
      subject,
      plainBody,
      {
        htmlBody: htmlBody,
        name: 'Vectorneu Solutions',
        replyTo: SENDER_EMAIL
      }
    );
    
    console.log('‚úÖ Confirmation email sent to:', bookingData.email);
    return { success: true };
    
  } catch (error) {
    console.error('‚ùå Email error:', error);
    return { success: false, error: error.message };
  }
}

// ========== RESCHEDULE FUNCTIONS ==========
function generateReferenceId() {
  const timestamp = new Date().getTime();
  const random = Math.random().toString(36).substring(2, 8).toUpperCase();
  return `VEC-${timestamp}-${random}`;
}

function handleBookAppointment(params) {
  try {
    const {
      fullName,
      email,
      companyName = '',
      purpose,
      date,
      time,
      duration = '60',
      additionalInfo = ''
    } = params;
    
    // Validate required fields
    if (!fullName || !email || !purpose || !date || !time) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'All required fields must be filled'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Generate reference ID
    const referenceId = generateReferenceId();
    
    // Create calendar event
    const calendar = CalendarApp.getDefaultCalendar();
    const startTime = new Date(`${date}T${time}`);
    const endTime = new Date(startTime.getTime() + parseInt(duration) * 60000);
    
    const eventTitle = `Vectorneu Meeting - ${fullName}`;
    const eventDescription = `
Purpose: ${purpose}
Company: ${companyName}
Email: ${email}
Duration: ${duration} minutes
Reference ID: ${referenceId}
Additional Info: ${additionalInfo}
    `.trim();
    
    const event = calendar.createEvent(eventTitle, startTime, endTime, {
      description: eventDescription,
      guests: email
    });
    
    // Create Google Meet link
    event.addConference();
    const meetLink = event.getConference()?.getJoinUrl() || '';
    
    // Store appointment in spreadsheet
    storeAppointmentInSheet({
      referenceId,
      fullName,
      email,
      companyName,
      purpose,
      date,
      time,
      duration,
      additionalInfo,
      meetLink,
      status: 'confirmed',
      createdAt: new Date().toISOString()
    });
    
    // Send confirmation email
    sendBookingConfirmationEmail(email, fullName, {
      referenceId,
      purpose,
      date,
      time,
      duration,
      meetLink,
      companyName,
      additionalInfo
    });
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Appointment booked successfully!',
      appointmentId: referenceId,
      meetLink: meetLink
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Booking error:', error);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Failed to book appointment: ' + error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function handleRescheduleAppointment(params) {
  try {
    console.log('üîÑ Starting appointment reschedule...', params);
    
    const {
      referenceId,
      email,
      newDate,
      newTime,
      duration = '60',
      reason = ''
    } = params;
    
    // Validate required fields
    if (!referenceId) {
      return { success: false, message: 'Reference ID is required' };
    }
    
    if (!email || !email.includes('@')) {
      return { success: false, message: 'Valid email is required' };
    }
    
    if (!newDate || !newTime) {
      return { success: false, message: 'New date and time are required' };
    }
    
    // Find existing appointment in spreadsheet
    const appointment = findAppointmentByReferenceId(referenceId);
    if (!appointment) {
      return { success: false, message: 'No appointment found with this Reference ID' };
    }
    
    // Verify email matches
    if (appointment.email !== email) {
      return { success: false, message: 'Email does not match the appointment record' };
    }
    
    console.log('‚úÖ Found appointment:', appointment.fullName);
    
    // Store old appointment details for email
    const oldAppointmentDetails = {
      date: appointment.date,
      time: appointment.time,
      duration: appointment.duration || '60'
    };
    
    // Update calendar event
    const calendarResult = updateCalendarEvent(appointment, newDate, newTime, duration, reason);
    
    // Update spreadsheet
    const sheetResult = updateAppointmentInSheet(referenceId, {
      date: newDate,
      time: newTime,
      duration: duration,
      status: 'rescheduled',
      rescheduledAt: new Date().toISOString(),
      rescheduleReason: reason
    });
    
    if (!sheetResult.success) {
      return { success: false, message: 'Failed to update appointment record: ' + sheetResult.error };
    }
    
    // Prepare appointment details for email
    const appointmentDetails = {
      referenceId: referenceId,
      fullName: appointment.fullName,
      email: appointment.email,
      oldDate: oldAppointmentDetails.date,
      oldTime: oldAppointmentDetails.time,
      oldDuration: oldAppointmentDetails.duration,
      newDate: newDate,
      newTime: newTime,
      newDuration: duration,
      reason: reason,
      meetLink: calendarResult.meetLink || ''
    };
    
    // Send reschedule confirmation email
    const emailResult = sendRescheduleConfirmationEmail(appointmentDetails);
    
    console.log('‚úÖ Appointment rescheduled successfully!');
    
    return {
      success: true,
      message: '‚úÖ Appointment rescheduled successfully!' + (emailResult.success ? ' Confirmation email sent.' : ''),
      referenceId: referenceId,
      emailSent: emailResult.success,
      calendarUpdated: calendarResult.success,
      meetLink: calendarResult.meetLink
    };
    
  } catch (error) {
    console.error('‚ùå Reschedule error:', error);
    return { success: false, message: 'Reschedule failed: ' + error.message };
  }
}

function sendRescheduleConfirmationEmail(appointmentDetails) {
  try {
    console.log('üìß Sending reschedule confirmation email...', appointmentDetails);
    
    // Validate required parameters
    if (!appointmentDetails || !appointmentDetails.email || !appointmentDetails.fullName) {
      console.error('‚ùå Missing required appointment details for email');
      return { success: false, error: 'Missing appointment details' };
    }
    
    const subject = 'üîÑ Appointment Rescheduled - Vectorneu Solutions';
    
    const htmlBody = `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .header { background: #f59e0b; color: white; padding: 20px; text-align: center; }
        .content { padding: 20px; }
        .details { background: #f8fafc; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .change-highlight { background: #fff7ed; padding: 10px; border-radius: 6px; margin: 10px 0; }
        .button { background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîÑ Appointment Rescheduled</h1>
        <p>Vectorneu Solutions - AI & Chatbot Services</p>
    </div>
    
    <div class="content">
        <h2>Hello ${appointmentDetails.fullName},</h2>
        <p>Your appointment has been successfully rescheduled!</p>
        
        <div class="details">
            <h3>üìÖ New Appointment Details:</h3>
            <p><strong>Reference ID:</strong> ${appointmentDetails.referenceId}</p>
            <p><strong>New Date:</strong> ${appointmentDetails.newDate}</p>
            <p><strong>New Time:</strong> ${appointmentDetails.newTime}</p>
            <p><strong>Duration:</strong> ${appointmentDetails.newDuration} minutes</p>
            
            <div class="change-highlight">
                <h4>Previous Timing:</h4>
                <p>Date: ${appointmentDetails.oldDate}<br>
                Time: ${appointmentDetails.oldTime}<br>
                Duration: ${appointmentDetails.oldDuration} minutes</p>
            </div>
            
            ${appointmentDetails.reason ? `<p><strong>Reschedule Reason:</strong> ${appointmentDetails.reason}</p>` : ''}
        </div>

        ${appointmentDetails.meetLink ? `
        <div class="details">
            <h3>üîó Updated Meeting Link:</h3>
            <a href="${appointmentDetails.meetLink}" class="button">Join Google Meet</a>
            <p style="font-size: 12px; color: #666;">Or copy this link: ${appointmentDetails.meetLink}</p>
        </div>
        ` : ''}

        <p>We look forward to connecting with you at the new time!</p>
        
        <p><strong>Contact us:</strong><br>
        üìß ${SENDER_EMAIL}<br>
        üìû +91 9488005400</p>
    </div>
</body>
</html>
    `.trim();
    
    const plainBody = `
APPOINTMENT RESCHEDULED - VECTORNEU SOLUTIONS

Hello ${appointmentDetails.fullName},

Your appointment has been successfully rescheduled.

NEW APPOINTMENT DETAILS:
Reference ID: ${appointmentDetails.referenceId}
New Date: ${appointmentDetails.newDate}
New Time: ${appointmentDetails.newTime}
Duration: ${appointmentDetails.newDuration} minutes

PREVIOUS TIMING:
Date: ${appointmentDetails.oldDate}
Time: ${appointmentDetails.oldTime}
Duration: ${appointmentDetails.oldDuration} minutes

${appointmentDetails.reason ? `Reschedule Reason: ${appointmentDetails.reason}` : ''}

${appointmentDetails.meetLink ? `MEETING LINK: ${appointmentDetails.meetLink}` : ''}

We look forward to connecting with you at the new time!

Contact: ${SENDER_EMAIL} | +91 9488005400
    `.trim();
    
    GmailApp.sendEmail(
      appointmentDetails.email,
      subject,
      plainBody,
      {
        htmlBody: htmlBody,
        name: 'Vectorneu Solutions',
        replyTo: SENDER_EMAIL
      }
    );
    
    console.log('‚úÖ Reschedule confirmation email sent to:', appointmentDetails.email);
    return { success: true };
    
  } catch (error) {
    console.error('‚ùå Reschedule email error:', error);
    return { success: false, error: error.message };
  }
}

function sendBookingConfirmationEmail(email, fullName, appointmentDetails) {
  try {
    // Validate required parameters
    if (!email || !fullName || !appointmentDetails) {
      console.error('Missing required parameters for booking email:', { email, fullName, appointmentDetails });
      return;
    }
    
    // Validate appointmentDetails structure
    if (!appointmentDetails.referenceId || !appointmentDetails.date || !appointmentDetails.time) {
      console.error('Invalid appointmentDetails structure for booking:', appointmentDetails);
      return;
    }
    
    const subject = `‚úÖ Appointment Confirmed - Vectorneu AI Solutions`;
    
    const htmlBody = `
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #2563eb, #7c3aed); color: white; padding: 20px; text-align: center; border-radius: 10px 10px 0 0; }
        .content { background: #f8fafc; padding: 20px; border-radius: 0 0 10px 10px; }
        .details { background: white; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #2563eb; }
        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #64748b; }
        .button { background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéâ Appointment Confirmed!</h1>
            <p>Thank you for choosing Vectorneu AI Solutions</p>
        </div>
        <div class="content">
            <p>Dear <strong>${fullName}</strong>,</p>
            <p>Your appointment has been successfully scheduled. Here are your appointment details:</p>
            
            <div class="details">
                <h3>üìÖ Appointment Details</h3>
                <p><strong>Reference ID:</strong> ${appointmentDetails.referenceId}</p>
                <p><strong>Purpose:</strong> ${appointmentDetails.purpose || 'Not specified'}</p>
                <p><strong>Date:</strong> ${formatDateForEmail(appointmentDetails.date)}</p>
                <p><strong>Time:</strong> ${appointmentDetails.time}</p>
                <p><strong>Duration:</strong> ${appointmentDetails.duration || '60'} minutes</p>
                ${appointmentDetails.companyName ? `<p><strong>Company:</strong> ${appointmentDetails.companyName}</p>` : ''}
                ${appointmentDetails.additionalInfo ? `<p><strong>Additional Info:</strong> ${appointmentDetails.additionalInfo}</p>` : ''}
            </div>

            ${appointmentDetails.meetLink ? `
            <div class="details">
                <h3>üîó Meeting Link</h3>
                <p>Join your meeting using the link below:</p>
                <a href="${appointmentDetails.meetLink}" class="button">Join Google Meet</a>
                <p style="font-size: 12px; color: #64748b;">Or copy this link: ${appointmentDetails.meetLink}</p>
            </div>
            ` : ''}

            <div class="details">
                <h3>üìã Important Notes</h3>
                <ul>
                    <li>Please join the meeting 5 minutes before the scheduled time</li>
                    <li>Keep your Reference ID (${appointmentDetails.referenceId}) for any future communications</li>
                    <li>If you need to reschedule, use the Reference ID in our chat</li>
                    <li>For any queries, reply to this email</li>
                </ul>
            </div>

            <p>We look forward to connecting with you!</p>
            <p>Best regards,<br><strong>The Vectorneu Team</strong></p>
        </div>
        <div class="footer">
            <p>Vectorneu AI Solutions ‚Ä¢ AI-Powered Business Solutions</p>
            <p>This is an automated message. Please do not reply directly to this email.</p>
        </div>
    </div>
</body>
</html>
    `;
    
    const plainBody = `
APPOINTMENT CONFIRMED - VECTORNEU AI SOLUTIONS

Dear ${fullName},

Your appointment has been successfully scheduled.

APPOINTMENT DETAILS:
Reference ID: ${appointmentDetails.referenceId}
Purpose: ${appointmentDetails.purpose || 'Not specified'}
Date: ${formatDateForEmail(appointmentDetails.date)}
Time: ${appointmentDetails.time}
Duration: ${appointmentDetails.duration || '60'} minutes
${appointmentDetails.companyName ? `Company: ${appointmentDetails.companyName}` : ''}
${appointmentDetails.additionalInfo ? `Additional Info: ${appointmentDetails.additionalInfo}` : ''}

${appointmentDetails.meetLink ? `MEETING LINK: ${appointmentDetails.meetLink}` : ''}

IMPORTANT NOTES:
- Please join the meeting 5 minutes before the scheduled time
- Keep your Reference ID (${appointmentDetails.referenceId}) for any future communications
- If you need to reschedule, use the Reference ID in our chat
- For any queries, reply to this email

We look forward to connecting with you!

Best regards,
The Vectorneu Team

Vectorneu AI Solutions ‚Ä¢ AI-Powered Business Solutions
This is an automated message. Please do not reply directly to this email.
    `;
    
    GmailApp.sendEmail(email, subject, plainBody, {
      htmlBody: htmlBody,
      name: 'Vectorneu AI Solutions'
    });
    
    console.log(`Booking confirmation email sent to ${email}`);
    
  } catch (error) {
    console.error('Error sending booking confirmation email:', error);
    console.error('Error details:', {
      email: email,
      fullName: fullName,
      appointmentDetails: appointmentDetails
    });
  }
}

// Helper function to format date for email
function formatDateForEmail(dateString) {
  try {
    const date = new Date(dateString + 'T00:00:00');
    return date.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  } catch (error) {
    return dateString;
  }
}

// Helper functions for spreadsheet storage
function storeAppointmentInSheet(appointmentData) {
  try {
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getActiveSheet();
    
    // Create headers if sheet is empty
    if (sheet.getLastRow() === 0) {
      sheet.getRange(1, 1, 1, 13).setValues([[
        'Reference ID', 'Full Name', 'Email', 'Company Name', 'Purpose', 
        'Date', 'Time', 'Duration', 'Additional Info', 'Meet Link', 
        'Status', 'Created At', 'Rescheduled At'
      ]]);
    }
    
    sheet.appendRow([
      appointmentData.referenceId,
      appointmentData.fullName,
      appointmentData.email,
      appointmentData.companyName,
      appointmentData.purpose,
      appointmentData.date,
      appointmentData.time,
      appointmentData.duration,
      appointmentData.additionalInfo,
      appointmentData.meetLink,
      appointmentData.status,
      appointmentData.createdAt,
      appointmentData.rescheduledAt || ''
    ]);
  } catch (error) {
    console.error('Error storing in sheet:', error);
  }
}
function findAppointmentByReferenceId(referenceId) {
  try {
    console.log('üîç Searching for appointment:', referenceId);
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = spreadsheet.getSheetByName('Appointments');
    
    if (!sheet) {
      console.log('‚ùå Appointments sheet not found');
      return null;
    }
    
    const data = sheet.getDataRange().getValues();
    
    if (data.length < 2) {
      console.log('‚ùå No appointment data found');
      return null;
    }
    
    const headers = data[0];
    console.log('üìã Headers:', headers);
    
    // Map column indices based on your original booking function
    const columnMap = {
      appointmentId: headers.indexOf('Appointment ID'),
      name: headers.indexOf('Name'),
      email: headers.indexOf('Email'),
      company: headers.indexOf('Company'),
      purpose: headers.indexOf('Purpose'),
      date: headers.indexOf('Date'),
      time: headers.indexOf('Time'),
      duration: headers.indexOf('Duration'),
      status: headers.indexOf('Status'),
      timestamp: headers.indexOf('Timestamp')
    };
    
    console.log('üó∫Ô∏è Column map:', columnMap);
    
    // Search for the appointment
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const rowAppointmentId = row[columnMap.appointmentId];
      
      console.log(`üîç Checking row ${i}:`, rowAppointmentId);
      
      if (rowAppointmentId && rowAppointmentId.toString().trim() === referenceId.toString().trim()) {
        console.log('‚úÖ FOUND MATCHING APPOINTMENT!');
        
        const appointment = {
          referenceId: rowAppointmentId,
          fullName: row[columnMap.name] || 'Customer',
          email: row[columnMap.email] || '',
          companyName: row[columnMap.company] || '',
          purpose: row[columnMap.purpose] || '',
          date: formatDateFromSheet(row[columnMap.date]),
          time: row[columnMap.time] || '',
          duration: row[columnMap.duration] || '60',
          status: row[columnMap.status] || 'Confirmed'
        };
        
        console.log('üìã Appointment details:', appointment);
        return appointment;
      }
    }
    
    console.log('‚ùå No appointment found with ID:', referenceId);
    return null;
    
  } catch (error) {
    console.error('‚ùå Error finding appointment:', error);
    return null;
  }
}

function formatDateFromSheet(dateValue) {
  try {
    if (!dateValue) return '';
    
    if (typeof dateValue === 'string') {
      return dateValue;
    }
    
    if (dateValue instanceof Date) {
      return Utilities.formatDate(dateValue, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    }
    
    // Handle Google Sheets date serial numbers
    const date = new Date(dateValue);
    if (!isNaN(date.getTime())) {
      return Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    }
    
    return dateValue.toString();
  } catch (error) {
    console.log('Date formatting error:', error);
    return dateValue ? dateValue.toString() : '';
  }
}
// Helper function to format dates from spreadsheet
function formatDateForSheet(dateValue) {
  try {
    if (!dateValue) return '';
    
    if (typeof dateValue === 'string') {
      return dateValue;
    }
    
    if (dateValue instanceof Date) {
      return Utilities.formatDate(dateValue, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    }
    
    // If it's a serial number (Google Sheets date)
    const date = new Date(dateValue);
    return Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM-dd');
  } catch (error) {
    console.log('Date formatting error:', error);
    return dateValue.toString();
  }
}


function updateAppointmentInSheet(referenceId, updateData) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('Appointments');
    
    if (!sheet) {
      return { success: false, error: 'Appointments sheet not found' };
    }
    
    const data = sheet.getDataRange().getValues();
    const headers = data[0];
    
    // Find column indices
    const refIdIndex = headers.indexOf('Appointment ID');
    const dateIndex = headers.indexOf('Date');
    const timeIndex = headers.indexOf('Time');
    const durationIndex = headers.indexOf('Duration');
    const statusIndex = headers.indexOf('Status');
    
    if (refIdIndex === -1) {
      return { success: false, error: 'Appointment ID column not found' };
    }
    
    // Find and update the row
    for (let i = 1; i < data.length; i++) {
      if (data[i][refIdIndex] === referenceId) {
        // Update the row
        if (updateData.date && dateIndex !== -1) {
          sheet.getRange(i + 1, dateIndex + 1).setValue(updateData.date);
        }
        if (updateData.time && timeIndex !== -1) {
          sheet.getRange(i + 1, timeIndex + 1).setValue(updateData.time);
        }
        if (updateData.duration && durationIndex !== -1) {
          sheet.getRange(i + 1, durationIndex + 1).setValue(updateData.duration);
        }
        if (updateData.status && statusIndex !== -1) {
          sheet.getRange(i + 1, statusIndex + 1).setValue(updateData.status);
        }
        
        console.log('‚úÖ Spreadsheet updated for reference:', referenceId);
        return { success: true };
      }
    }
    
    return { success: false, error: 'Appointment not found in sheet' };
    
  } catch (error) {
    console.error('‚ùå Spreadsheet update error:', error);
    return { success: false, error: error.message };
  }
}
function debugSpreadsheetStructure() {
  try {
    console.log('üîç DEBUGGING SPREADSHEET STRUCTURE...');
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    console.log('üìä Spreadsheet:', spreadsheet.getName());
    
    // Check all sheets
    const sheets = spreadsheet.getSheets();
    console.log('üìë Available sheets:');
    sheets.forEach(sheet => {
      console.log(`- ${sheet.getName()}: ${sheet.getLastRow()} rows`);
    });
    
    // Focus on Appointments sheet
    let appointmentsSheet = spreadsheet.getSheetByName('Appointments');
    if (!appointmentsSheet) {
      console.log('‚ùå No "Appointments" sheet found!');
      console.log('üí° Creating a new Appointments sheet...');
      appointmentsSheet = spreadsheet.insertSheet('Appointments');
      // Add headers
      const headers = ['Appointment ID', 'Name', 'Email', 'Company', 'Purpose', 'Date', 'Time', 'Duration', 'Status', 'Timestamp'];
      appointmentsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      console.log('‚úÖ Created new Appointments sheet with headers');
    }
    
    const data = appointmentsSheet.getDataRange().getValues();
    console.log(`üìà Appointments sheet has ${data.length} rows`);
    
    if (data.length === 0) {
      console.log('‚ùå No data in Appointments sheet');
      return { success: false, message: 'No data found' };
    }
    
    // Log headers
    console.log('üìã HEADERS:');
    data[0].forEach((header, index) => {
      console.log(`  ${index + 1}. "${header}"`);
    });
    
    // Log sample data
    console.log('üìù SAMPLE DATA (first 3 rows):');
    for (let i = 1; i < Math.min(4, data.length); i++) {
      console.log(`Row ${i + 1}:`, data[i]);
    }
    
    // Check specific columns
    const headers = data[0];
    const refIdIndex = headers.findIndex(h => h.toString().toLowerCase().includes('appointment') || h.toString().toLowerCase().includes('id'));
    const nameIndex = headers.findIndex(h => h.toString().toLowerCase().includes('name'));
    const emailIndex = headers.findIndex(h => h.toString().toLowerCase().includes('email'));
    
    console.log('üîç KEY COLUMN INDICES:');
    console.log('- Reference ID:', refIdIndex);
    console.log('- Name:', nameIndex);
    console.log('- Email:', emailIndex);
    
    return {
      success: true,
      headers: headers,
      sampleData: data.slice(0, Math.min(4, data.length)),
      columnIndices: {
        referenceId: refIdIndex,
        name: nameIndex,
        email: emailIndex
      }
    };
    
  } catch (error) {
    console.error('‚ùå Debug error:', error);
    return { success: false, error: error.message };
  }
}

// Run this first to see your spreadsheet structure
function testDebug() {
  const result = debugSpreadsheetStructure();
  console.log('Debug result:', result);
  return result;
}

function debugAppointmentStructure() {
  try {
    console.log('üîç Debugging appointment structure...');
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('Appointments');
    
    if (!sheet) {
      console.log('‚ùå Appointments sheet not found!');
      // Let's see what sheets exist
      const sheets = spreadsheet.getSheets();
      console.log('Available sheets:', sheets.map(s => s.getName()));
      return { success: false, message: 'Appointments sheet not found' };
    }
    
    const data = sheet.getDataRange().getValues();
    console.log('üìä Total rows in sheet:', data.length);
    
    if (data.length === 0) {
      console.log('‚ùå No data in Appointments sheet');
      return { success: false, message: 'No data in sheet' };
    }
    
    // Log headers
    const headers = data[0];
    console.log('üìã Headers:', headers);
    
    // Log first few rows of data
    console.log('üìù First 3 rows of data:');
    for (let i = 1; i < Math.min(4, data.length); i++) {
      console.log(`Row ${i}:`, data[i]);
    }
    
    // Check if we have any appointments with reference IDs
    const refIdIndex = headers.findIndex(header => 
      header.toLowerCase().includes('appointment') || 
      header.toLowerCase().includes('reference') ||
      header.toLowerCase().includes('id')
    );
    
    console.log('üîç Reference ID column index:', refIdIndex);
    
    if (refIdIndex !== -1) {
      console.log('üìã All reference IDs in sheet:');
      for (let i = 1; i < data.length; i++) {
        if (data[i][refIdIndex]) {
          console.log(`Row ${i}: ${data[i][refIdIndex]}`);
        }
      }
    }
    
    return {
      success: true,
      headers: headers,
      rowCount: data.length - 1,
      sampleData: data.slice(0, Math.min(4, data.length))
    };
    
  } catch (error) {
    console.error('‚ùå Debug error:', error);
    return { success: false, error: error.message };
  }
}

// Run this to debug your spreadsheet
function testDebug() {
  const result = debugAppointmentStructure();
  console.log('Debug result:', result);
  return result;
}

function handleRescheduleAppointment(params) {
  try {
    console.log('üîÑ STARTING RESCHEDULE PROCESS...');
    console.log('üìã Received parameters:', params);
    
    const {
      referenceId,
      email,
      newDate,
      newTime,
      duration = '60',
      reason = ''
    } = params;
    
    // Validate required fields
    if (!referenceId) {
      console.log('‚ùå Missing referenceId');
      return { success: false, message: 'Reference ID is required' };
    }
    
    if (!email || !email.includes('@')) {
      console.log('‚ùå Invalid email:', email);
      return { success: false, message: 'Valid email is required' };
    }
    
    if (!newDate || !newTime) {
      console.log('‚ùå Missing date/time:', { newDate, newTime });
      return { success: false, message: 'New date and time are required' };
    }
    
    console.log('‚úÖ Basic validation passed');
    
    // Find existing appointment in spreadsheet
    console.log('üîç Searching for appointment with referenceId:', referenceId);
    const appointment = findAppointmentByReferenceId(referenceId);
    console.log('üîç Appointment search result:', appointment);
    
    if (!appointment) {
      console.log('‚ùå No appointment found with referenceId:', referenceId);
      return { success: false, message: 'No appointment found with this Reference ID' };
    }
    
    // Verify email matches
    console.log('üîê Verifying email match:', { 
      providedEmail: email, 
      storedEmail: appointment.email 
    });
    
    if (appointment.email !== email) {
      console.log('‚ùå Email mismatch');
      return { success: false, message: 'Email does not match the appointment record' };
    }
    
    console.log('‚úÖ Email verification passed');
    
    // Store old appointment details for email
    const oldAppointmentDetails = {
      date: appointment.date,
      time: appointment.time,
      duration: appointment.duration || '60'
    };
    
    console.log('üìÖ Old appointment details:', oldAppointmentDetails);
    
    // Update calendar event
    console.log('üìÖ Updating calendar event...');
    const calendarResult = updateCalendarEvent(appointment, newDate, newTime, duration, reason);
    console.log('üìÖ Calendar update result:', calendarResult);
    
    // Update spreadsheet
    console.log('üìä Updating spreadsheet...');
    const sheetResult = updateAppointmentInSheet(referenceId, {
      date: newDate,
      time: newTime,
      duration: duration,
      status: 'rescheduled',
      rescheduledAt: new Date().toISOString(),
      rescheduleReason: reason
    });
    console.log('üìä Spreadsheet update result:', sheetResult);
    
    if (!sheetResult.success) {
      console.log('‚ùå Spreadsheet update failed');
      return { success: false, message: 'Failed to update appointment record: ' + sheetResult.error };
    }
    
    // Prepare appointment details for email
    const appointmentDetails = {
      referenceId: referenceId,
      fullName: appointment.fullName,
      email: appointment.email,
      oldDate: oldAppointmentDetails.date,
      oldTime: oldAppointmentDetails.time,
      oldDuration: oldAppointmentDetails.duration,
      newDate: newDate,
      newTime: newTime,
      newDuration: duration,
      reason: reason,
      meetLink: calendarResult.meetLink || ''
    };
    
    console.log('üìß Prepared appointment details for email:', appointmentDetails);
    
    // Send reschedule confirmation email
    console.log('üìß Calling email function...');
    const emailResult = sendRescheduleConfirmationEmail(appointmentDetails);
    console.log('üìß Email result:', emailResult);
    
    console.log('‚úÖ RESCHEDULE PROCESS COMPLETED SUCCESSFULLY!');
    
    return {
      success: true,
      message: '‚úÖ Appointment rescheduled successfully!' + (emailResult.success ? ' Confirmation email sent.' : ''),
      referenceId: referenceId,
      emailSent: emailResult.success,
      calendarUpdated: calendarResult.success,
      meetLink: calendarResult.meetLink
    };
    
  } catch (error) {
    console.error('‚ùå RESCHEDULE ERROR:', error);
    return { success: false, message: 'Reschedule failed: ' + error.message };
  }
}

// ========== TEST FUNCTIONS ==========
function testCalendarAccess() {
  try {
    console.log('üîç Testing calendar access...');
    
    const calendar = CalendarApp.getCalendarById(CALENDAR_ID);
    if (!calendar) {
      return { success: false, error: 'Calendar not found' };
    }
    
    return { 
      success: true, 
      message: '‚úÖ Calendar access working!',
      calendarName: calendar.getName()
    };
    
  } catch (error) {
    console.error('‚ùå Calendar test failed:', error);
    return { success: false, error: error.message };
  }
}

function testKnowledgeBase() {
  try {
    console.log('üß† Testing knowledge base...');
    
    const testQuery = "AI services";
    const knowledge = getRelevantKnowledge(testQuery);
    
    return {
      success: true,
      message: '‚úÖ Knowledge base working!',
      testQuery: testQuery,
      knowledgeSample: knowledge.substring(0, 500) + '...'
    };
    
  } catch (error) {
    console.error('‚ùå Knowledge base test failed:', error);
    return { success: false, error: error.message };
  }
}

function testGroqAPI() {
  try {
    console.log('ü§ñ Testing Groq API...');
    
    const testMessage = "Hello! What AI services do you offer?";
    const response = callGroqAPI(SYSTEM_PROMPT, testMessage);
    
    return {
      success: true,
      message: '‚úÖ Groq API working!',
      testMessage: testMessage,
      aiResponse: response
    };
    
  } catch (error) {
    console.error('‚ùå Groq API test failed:', error);
    return { success: false, error: error.message };
  }
}
function testReschedule() {
  const testParams = {
    action: 'rescheduleAppointment',
    referenceId: 'VEC-ABC123', // Use a real reference ID from your spreadsheet
    email: 'test@example.com', // Use the email associated with that appointment
    newDate: '2024-12-25',
    newTime: '14:30',
    duration: '45',
    reason: 'Test reschedule'
  };
  
  const result = handleRescheduleAppointment(testParams);
  console.log('Test result:', result);
  return result;
}
function testAndDebug() {
  console.log('=== DEBUGGING APPOINTMENT SYSTEM ===');
  
  // 1. Check spreadsheet structure
  const debugResult = debugAppointmentStructure();
  console.log('Debug Structure Result:', debugResult);
  
  // 2. If we have appointments, test finding one
  if (debugResult.success && debugResult.rowCount > 0) {
    const testReferenceId = 'VEC-ABC123'; // Replace with a real ID from your logs
    console.log('=== TESTING APPOINTMENT SEARCH ===');
    const appointment = findAppointmentByReferenceId(testReferenceId);
    console.log('Appointment Search Result:', appointment);
  }
  
  return debugResult;
}

function createTestAppointment() {
  try {
    console.log('üìù Creating test appointment...');
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('Appointments');
    
    if (!sheet) {
      console.log('‚ùå Appointments sheet not found, creating...');
      sheet = spreadsheet.insertSheet('Appointments');
      const headers = ['Appointment ID', 'Name', 'Email', 'Company', 'Purpose', 'Date', 'Time', 'Duration', 'Status', 'Timestamp'];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    }
    
    const testAppointment = {
      appointmentId: 'VEC-TEST123',
      name: 'Test User',
      email: 'test@example.com',
      company: 'Test Company',
      purpose: 'AI Consultation',
      date: '2024-12-25',
      time: '14:00',
      duration: '60',
      status: 'Confirmed',
      timestamp: new Date()
    };
    
    const rowData = [
      testAppointment.appointmentId,
      testAppointment.name,
      testAppointment.email,
      testAppointment.company,
      testAppointment.purpose,
      testAppointment.date,
      testAppointment.time,
      testAppointment.duration,
      testAppointment.status,
      testAppointment.timestamp
    ];
    
    sheet.appendRow(rowData);
    console.log('‚úÖ Test appointment created:', testAppointment.appointmentId);
    
    return {
      success: true,
      appointmentId: testAppointment.appointmentId,
      message: 'Test appointment created successfully'
    };
    
  } catch (error) {
    console.error('‚ùå Error creating test appointment:', error);
    return { success: false, error: error.message };
  }
}

function testCompleteRescheduleFlow() {
  console.log('=== TESTING COMPLETE RESCHEDULE FLOW ===');
  
  // Step 1: Debug spreadsheet structure
  console.log('1. üîç Debugging spreadsheet structure...');
  const debugResult = debugSpreadsheetStructure();
  if (!debugResult.success) {
    console.log('‚ùå Debug failed, creating test appointment...');
    const testAppointment = createTestAppointment();
    if (!testAppointment.success) {
      return { success: false, message: 'Failed to create test appointment' };
    }
  }
  
  // Step 2: Test finding an appointment
  console.log('2. üîç Testing appointment search...');
  const testReferenceId = 'VEC-TEST123'; // Use the test ID or a real one from your sheet
  const appointment = findAppointmentByReferenceId(testReferenceId);
  
  if (!appointment) {
    console.log('‚ùå No appointment found, creating one...');
    const newAppointment = createTestAppointment();
    if (newAppointment.success) {
      console.log('‚úÖ Created test appointment, trying again...');
      const appointment = findAppointmentByReferenceId(newAppointment.appointmentId);
      console.log('Appointment found:', appointment);
    }
  } else {
    console.log('‚úÖ Appointment found:', appointment);
  }
  
  // Step 3: Test reschedule with the found appointment
  if (appointment) {
    console.log('3. üîÑ Testing reschedule...');
    const testParams = {
      referenceId: appointment.referenceId,
      email: appointment.email,
      newDate: '2024-12-26',
      newTime: '15:30',
      duration: '45',
      reason: 'Test reschedule'
    };
    
    console.log('üìã Test parameters:', testParams);
    const result = handleRescheduleAppointment(testParams);
    console.log('‚úÖ Reschedule result:', result);
    
    return result;
  } else {
    console.log('‚ùå No appointment to test with');
    return { success: false, message: 'No appointment found for testing' };
  }
}
